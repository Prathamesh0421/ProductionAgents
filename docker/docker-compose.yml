version: '3.8'

# Self-Healing DevOps Engine - Docker Compose Configuration
# Includes: OCP, Lightpanda, Redis

services:
  # Orchestration Control Plane (OCP)
  ocp:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ocp
    container_name: self-healing-ocp
    ports:
      - "${OCP_PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      # PagerDuty
      - PAGERDUTY_API_KEY=${PAGERDUTY_API_KEY}
      - PAGERDUTY_WEBHOOK_SECRET=${PAGERDUTY_WEBHOOK_SECRET}
      - PAGERDUTY_SERVICE_ID=${PAGERDUTY_SERVICE_ID}
      # Cleric
      - CLERIC_AGENT_NAME=${CLERIC_AGENT_NAME:-Cleric AI}
      - CLERIC_AGENT_EMAIL=${CLERIC_AGENT_EMAIL:-}
      # Senso (Stream B)
      - SENSO_API_URL=${SENSO_API_URL}
      - SENSO_API_KEY=${SENSO_API_KEY}
      # Anthropic (Stream B)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-3-sonnet-20240229}
      # Coder (Stream C)
      - CODER_API_URL=${CODER_API_URL}
      - CODER_API_TOKEN=${CODER_API_TOKEN}
      - CODER_TEMPLATE_ID=${CODER_TEMPLATE_ID}
      # Lightpanda
      - LIGHTPANDA_WS_ENDPOINT=ws://lightpanda:9222
      # Slack
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
      - SLACK_APPROVAL_CHANNEL=${SLACK_APPROVAL_CHANNEL:-incident-approvals}
      # Thresholds
      - CONFIDENCE_AUTO_EXECUTE_THRESHOLD=${CONFIDENCE_AUTO_EXECUTE_THRESHOLD:-90}
      - SENSO_MATCH_THRESHOLD=${SENSO_MATCH_THRESHOLD:-85}
    depends_on:
      redis:
        condition: service_healthy
      lightpanda:
        condition: service_started
    volumes:
      - ocp-logs:/app/logs
    networks:
      - self-healing-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Lightpanda - High-velocity headless browser
  lightpanda:
    image: lightpanda/browser:nightly
    container_name: self-healing-lightpanda
    ports:
      - "${LIGHTPANDA_PORT:-9222}:9222"
    environment:
      - LIGHTPANDA_DISABLE_TELEMETRY=true
    networks:
      - self-healing-network
    restart: unless-stopped
    # Resource limits for stability
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'

  # Redis - State management
  redis:
    image: redis:7-alpine
    container_name: self-healing-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      ${REDIS_PASSWORD:+--requirepass ${REDIS_PASSWORD}}
    volumes:
      - redis-data:/data
    networks:
      - self-healing-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  # Optional: Redis Commander for debugging
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: self-healing-redis-commander
    ports:
      - "${REDIS_COMMANDER_PORT:-8081}:8081"
    environment:
      - REDIS_HOSTS=local:redis:6379${REDIS_PASSWORD:+:${REDIS_PASSWORD}}
    depends_on:
      - redis
    networks:
      - self-healing-network
    profiles:
      - debug
    restart: unless-stopped

networks:
  self-healing-network:
    driver: bridge
    name: self-healing-network

volumes:
  redis-data:
    name: self-healing-redis-data
  ocp-logs:
    name: self-healing-ocp-logs
