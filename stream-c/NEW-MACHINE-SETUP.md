# Coder Setup on New Laptop - Quick Guide

## ðŸš€ One-Command Setup

On your **new laptop**, run this single command:

```bash
curl -fsSL https://raw.githubusercontent.com/Prathamesh0421/ProductionAgents/main/stream-c/setup-new-machine.sh | bash
```

This will automatically:
- âœ… Install Homebrew (if needed)
- âœ… Install Coder CLI
- âœ… Install Terraform v1.14.0
- âœ… Install jq
- âœ… Clone the ProductionAgents repo
- âœ… Start Coder server
- âœ… Create admin user
- âœ… Push remediation template
- âœ… Configure .env file

**Total time**: ~5 minutes

---

## ðŸ“‹ Manual Setup (Step-by-Step)

If you prefer to run commands manually:

### 1. Install Prerequisites

```bash
# Install Homebrew (if not installed)
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Install Coder CLI
brew install coder

# Install Terraform (latest version)
brew tap hashicorp/tap
brew install hashicorp/tap/terraform

# Install jq
brew install jq
```

### 2. Clone Repository

```bash
cd ~
git clone https://github.com/Prathamesh0421/ProductionAgents.git
cd ProductionAgents
```

### 3. Create .env File

```bash
cp .env.example .env
# Edit .env and add your credentials
```

### 4. Start Coder Server

```bash
# Start in background
nohup coder server > coder-server.log 2>&1 &

# Wait for it to be ready
sleep 10
curl http://localhost:3000/api/v2/buildinfo
```

### 5. Create Admin User

```bash
curl -X POST http://localhost:3000/api/v2/users/first \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "username": "admin",
    "password": "SecurePassword123!",
    "name": "Admin"
  }'
```

### 6. Run Setup Script

```bash
./stream-c/setup-coder-env.sh
```

This will:
- Login and get session token
- Push the remediation template
- Update .env with Coder configuration

---

## ðŸ”§ Configuration

After setup, your `.env` file will have:

```bash
CODER_API_URL=http://localhost:3000
CODER_API_TOKEN=<auto-generated>
CODER_TEMPLATE_ID=<auto-generated>
```

---

## ðŸŒ Access Coder

**Web UI**: http://localhost:3000

**Credentials**:
- Email: `admin@example.com`
- Password: `SecurePassword123!`

---

## ðŸ“ Verify Installation

```bash
# Check Coder server is running
curl http://localhost:3000/api/v2/buildinfo

# Check template exists
source .env
curl -H "Coder-Session-Token: $CODER_API_TOKEN" \
  "$CODER_API_URL/api/v2/templates/$CODER_TEMPLATE_ID" | jq -r '.name'
# Should output: remediation-template
```

---

## ðŸ›‘ Stop Coder Server

```bash
pkill -f 'coder server'
```

---

## ðŸ”„ Restart Coder Server

```bash
cd ~/ProductionAgents
nohup coder server > coder-server.log 2>&1 &
```

---

## ðŸ“Š View Logs

```bash
tail -f ~/ProductionAgents/coder-server.log
```

---

## ðŸ” Update Session Token (if expired)

Session tokens expire after 24 hours. To get a new one:

```bash
cd ~/ProductionAgents
./stream-c/setup-coder-env.sh
# Select 'y' to update .env
```

---

## ðŸ› Troubleshooting

### Server won't start
```bash
# Check if port 3000 is already in use
lsof -i :3000

# Kill existing process
pkill -f 'coder server'

# Start again
cd ~/ProductionAgents
coder server
```

### Template push fails
```bash
# Make sure Terraform is up to date
terraform version
# Should be >= 1.9

# Upgrade if needed
brew upgrade hashicorp/tap/terraform

# Clean and reinitialize
cd ~/ProductionAgents/stream-c/week-2/terraform
rm -rf .terraform .terraform.lock.hcl
terraform init
```

### Can't login
```bash
# Reset admin password
curl -X POST http://localhost:3000/api/v2/users/first \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "username": "admin",
    "password": "SecurePassword123!",
    "name": "Admin"
  }'
```

---

## ðŸ“¦ What Gets Installed

| Tool | Version | Purpose |
|------|---------|---------|
| Homebrew | Latest | Package manager |
| Coder CLI | Latest | Interact with Coder server |
| Terraform | 1.14.0+ | Define workspace templates |
| jq | Latest | Parse JSON responses |

---

## ðŸ“‚ Directory Structure

After setup:

```
~/ProductionAgents/
â”œâ”€â”€ .env                           # Your configuration
â”œâ”€â”€ coder-server.log              # Server logs
â”œâ”€â”€ stream-c/
â”‚   â”œâ”€â”€ setup-new-machine.sh      # Automated setup script
â”‚   â”œâ”€â”€ setup-coder-env.sh        # Token/template setup
â”‚   â””â”€â”€ week-2/terraform/         # Remediation template
â””â”€â”€ src/                          # Application code
```

---

## âœ… Success Checklist

- [ ] Coder server running at http://localhost:3000
- [ ] Can login with admin@example.com
- [ ] Template "remediation-template" exists
- [ ] .env file has CODER_API_URL, CODER_API_TOKEN, CODER_TEMPLATE_ID
- [ ] Can create a test workspace

---

## ðŸš€ Next Steps

1. **Update other credentials** in `.env`:
   - PagerDuty API keys
   - Sanity tokens
   - Skyflow configuration
   - etc.

2. **Test the application**:
   ```bash
   npm install
   npm start
   ```

3. **Create a test workspace**:
   ```bash
   source .env
   curl -X POST -H "Coder-Session-Token: $CODER_API_TOKEN" \
     -H "Content-Type: application/json" \
     "$CODER_API_URL/api/v2/users/admin/workspaces" \
     -d "{
       \"template_id\": \"$CODER_TEMPLATE_ID\",
       \"name\": \"test-$(date +%s)\"
     }" | jq
   ```

---

**Need help?** Check the troubleshooting section or review logs at `~/ProductionAgents/coder-server.log`
